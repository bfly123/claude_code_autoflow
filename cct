#!/bin/bash
# cct - Claude Code TriFlow CLI
# Manage TriFlow skill installations across projects

set -e

VERSION="1.0.0"
CCT_HOME="${CCT_HOME:-$HOME/.cct}"
CCT_SOURCE="${CCT_SOURCE:-$HOME/yunwei/claude_triflows}"
INSTALLATIONS_FILE="$CCT_HOME/installations"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Ensure CCT_HOME exists
mkdir -p "$CCT_HOME"
touch "$INSTALLATIONS_FILE"

usage() {
    cat << EOF
cct - Claude Code TriFlow CLI v$VERSION

Usage: cct <command> [options]

Commands:
  add .          Install TriFlow to current project
  add all        Install TriFlow to system (~/.claude/commands)
  add <path>     Install TriFlow to specific project

  delete .       Remove TriFlow from current project
  delete all     Remove system installation
  delete <path>  Remove TriFlow from specific project

  update         Update cct and refresh all installations
  list           Show all installations
  uninstall      Completely remove cct from system

  version        Show version
  help           Show this help

Examples:
  cct add .                  # Install to current project
  cct add all                # Install globally
  cct add ~/myproject        # Install to specific project
  cct delete .               # Remove from current project
  cct update                 # Update cct and all installations

Config:
  CCT_HOME=$CCT_HOME
  CCT_SOURCE=$CCT_SOURCE
EOF
}

log_info() { echo -e "${GREEN}[+]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[!]${NC} $1"; }
log_error() { echo -e "${RED}[-]${NC} $1"; }
log_blue() { echo -e "${BLUE}[*]${NC} $1"; }

# Record installation path
record_installation() {
    local path="$1"
    local type="$2"  # project or system
    # Remove existing entry if any
    grep -v "^$path|" "$INSTALLATIONS_FILE" > "$INSTALLATIONS_FILE.tmp" 2>/dev/null || true
    mv "$INSTALLATIONS_FILE.tmp" "$INSTALLATIONS_FILE"
    # Add new entry with trailing newline
    printf "%s|%s|%s\n" "$path" "$type" "$(date +%Y-%m-%d)" >> "$INSTALLATIONS_FILE"
}

# Remove installation record
remove_installation() {
    local path="$1"
    grep -v "^$path|" "$INSTALLATIONS_FILE" > "$INSTALLATIONS_FILE.tmp" 2>/dev/null || true
    mv "$INSTALLATIONS_FILE.tmp" "$INSTALLATIONS_FILE"
}

# Check source files exist
check_source() {
    if [[ ! -d "$CCT_SOURCE/.claude/skills" ]]; then
        log_error "Skills not found in $CCT_SOURCE/.claude/skills/"
        log_error "Set CCT_SOURCE to your claude_triflows directory"
        exit 1
    fi
    if [[ ! -d "$CCT_SOURCE/.claude/commands" ]]; then
        log_error "Commands not found in $CCT_SOURCE/.claude/commands/"
        exit 1
    fi
}

# Install to a directory
do_install() {
    local target="$1"
    local type="$2"

    check_source

    # Copy skills directory
    local skills_dir="$target/.claude/skills"
    mkdir -p "$skills_dir"
    cp -r "$CCT_SOURCE/.claude/skills/"* "$skills_dir/"

    # Copy commands directory (slash command redirects)
    local cmd_dir="$target/.claude/commands"
    mkdir -p "$cmd_dir"
    cp "$CCT_SOURCE/.claude/commands/"*.md "$cmd_dir/"

    # Add CLAUDE.md content for project installations
    if [[ "$type" == "project" ]]; then
        local claude_md="$target/CLAUDE.md"
        local triflow_marker="<!-- TRIFLOW -->"

        if [[ ! -f "$claude_md" ]]; then
            # Create new CLAUDE.md with TriFlow section
            cat > "$claude_md" << 'TRIFLOW_EOF'
<!-- TRIFLOW -->
## TriFlow

Task execution workflow. After `/clear`, read:
- `todo.md` - current task and steps
- `state.json` - progress state

Commands: `/tp [requirement]` (plan), `/tr` (run)
<!-- /TRIFLOW -->
TRIFLOW_EOF
            log_info "Created: CLAUDE.md"
        elif ! grep -q "$triflow_marker" "$claude_md"; then
            # Append TriFlow section to existing CLAUDE.md
            cat >> "$claude_md" << 'TRIFLOW_EOF'

<!-- TRIFLOW -->
## TriFlow

Task execution workflow. After `/clear`, read:
- `todo.md` - current task and steps
- `state.json` - progress state

Commands: `/tp [requirement]` (plan), `/tr` (run)
<!-- /TRIFLOW -->
TRIFLOW_EOF
            log_info "Updated: CLAUDE.md (added TriFlow section)"
        fi
    fi

    record_installation "$target" "$type"

    log_info "Installed to: $target/.claude/"
    echo "  - skills/ (tr, tp, dual-design, file-op, mode-switch, review, ask-codex, docs)"
    echo "  - commands/ (slash command redirects)"
}

# Remove from a directory
do_remove() {
    local target="$1"
    local skills_dir="$target/.claude/skills"
    local cmd_dir="$target/.claude/commands"

    if [[ -d "$skills_dir" ]] || [[ -d "$cmd_dir" ]]; then
        # Remove skills directory
        rm -rf "$skills_dir" 2>/dev/null || true
        # Remove commands directory
        rm -rf "$cmd_dir" 2>/dev/null || true
        # Remove empty .claude directory
        rmdir "$target/.claude" 2>/dev/null || true
        remove_installation "$target"
        log_info "Removed from: $target"

        # Clean TriFlow section from CLAUDE.md
        local claude_md="$target/CLAUDE.md"
        if [[ -f "$claude_md" ]] && grep -q "<!-- TRIFLOW -->" "$claude_md"; then
            # Remove TriFlow section
            sed -i '/<!-- TRIFLOW -->/,/<!-- \/TRIFLOW -->/d' "$claude_md"
            # Remove empty CLAUDE.md
            if [[ ! -s "$claude_md" ]] || ! grep -q '[^[:space:]]' "$claude_md"; then
                rm -f "$claude_md"
                log_info "Removed: CLAUDE.md (was empty)"
            else
                log_info "Cleaned: CLAUDE.md (removed TriFlow section)"
            fi
        fi
    else
        log_warn "TriFlow not found in: $target/.claude/"
    fi
}

# Command: add
cmd_add() {
    local target="$1"

    if [[ -z "$target" ]]; then
        log_error "Usage: cct add <.|all|path>"
        exit 1
    fi

    case "$target" in
        ".")
            target="$(pwd)"
            log_blue "Installing to current project: $target"
            do_install "$target" "project"
            ;;
        "all")
            target="$HOME"
            log_blue "Installing to system: ~/.claude/commands"
            do_install "$target" "system"
            ;;
        *)
            # Resolve path
            if [[ "$target" != /* ]]; then
                target="$(pwd)/$target"
            fi
            target="$(cd "$target" 2>/dev/null && pwd)" || {
                log_error "Directory not found: $target"
                exit 1
            }
            log_blue "Installing to: $target"
            do_install "$target" "project"
            ;;
    esac

    echo ""
    log_info "Done! Use /tp and /tr in Claude Code."
}

# Command: delete
cmd_delete() {
    local target="$1"

    if [[ -z "$target" ]]; then
        log_error "Usage: cct delete <.|all|path>"
        exit 1
    fi

    case "$target" in
        ".")
            target="$(pwd)"
            log_blue "Removing from current project: $target"
            do_remove "$target"
            ;;
        "all")
            target="$HOME"
            log_blue "Removing system installation"
            do_remove "$target"
            ;;
        *)
            if [[ "$target" != /* ]]; then
                target="$(pwd)/$target"
            fi
            target="$(cd "$target" 2>/dev/null && pwd)" || {
                log_error "Directory not found: $target"
                exit 1
            }
            log_blue "Removing from: $target"
            do_remove "$target"
            ;;
    esac
}

# Command: update
cmd_update() {
    log_blue "Updating cct..."

    # Update cct itself from source
    if [[ -f "$CCT_SOURCE/cct" ]]; then
        local cct_path="$(which cct 2>/dev/null || echo "$HOME/.local/bin/cct")"
        if [[ -w "$cct_path" ]] || [[ -w "$(dirname "$cct_path")" ]]; then
            cp "$CCT_SOURCE/cct" "$cct_path"
            chmod +x "$cct_path"
            log_info "Updated cct binary"
        else
            log_warn "Cannot update cct binary (no write permission)"
        fi
    fi

    # Update all recorded installations
    check_source

    local count=0
    while IFS='|' read -r path type date; do
        [[ -z "$path" ]] && continue
        if [[ -d "$path" ]]; then
            log_blue "Updating: $path"
            do_install "$path" "$type"
            ((count++))
        else
            log_warn "Skipping (not found): $path"
            remove_installation "$path"
        fi
    done < "$INSTALLATIONS_FILE"

    echo ""
    log_info "Updated $count installation(s)"
}

# Command: list
cmd_list() {
    log_blue "TriFlow installations:"
    echo ""

    # Check if file has any non-whitespace content
    if ! grep -q '[^[:space:]]' "$INSTALLATIONS_FILE" 2>/dev/null; then
        echo "  (none)"
        return
    fi

    printf "  %-50s %-10s %s\n" "PATH" "TYPE" "DATE"
    printf "  %-50s %-10s %s\n" "----" "----" "----"

    while IFS='|' read -r path type date; do
        [[ -z "$path" ]] && continue
        local status=""
        if [[ -d "$path/.claude/skills" ]]; then
            status="${GREEN}✓${NC}"
        else
            status="${RED}✗${NC}"
        fi
        printf "  %-50s %-10s %s %b\n" "$path" "$type" "$date" "$status"
    done < "$INSTALLATIONS_FILE"
}

# Command: uninstall
cmd_uninstall() {
    log_warn "This will remove cct from your system."
    echo ""
    read -p "Remove all TriFlow installations too? [y/N] " -n 1 -r
    echo ""

    if [[ $REPLY =~ ^[Yy]$ ]]; then
        # Remove all installations
        while IFS='|' read -r path type date; do
            [[ -z "$path" ]] && continue
            if [[ -d "$path" ]]; then
                do_remove "$path"
            fi
        done < "$INSTALLATIONS_FILE"
    fi

    # Remove cct binary
    local cct_path="$(which cct 2>/dev/null)"
    if [[ -n "$cct_path" ]] && [[ -f "$cct_path" ]]; then
        rm -f "$cct_path"
        log_info "Removed: $cct_path"
    fi

    # Remove cct config
    rm -rf "$CCT_HOME"
    log_info "Removed: $CCT_HOME"

    echo ""
    log_info "cct uninstalled. Goodbye!"
}

# Main
case "${1:-}" in
    add)
        cmd_add "$2"
        ;;
    delete|remove|rm)
        cmd_delete "$2"
        ;;
    update|upgrade)
        cmd_update
        ;;
    list|ls)
        cmd_list
        ;;
    uninstall)
        cmd_uninstall
        ;;
    version|-v|--version)
        echo "cct v$VERSION"
        ;;
    help|-h|--help|"")
        usage
        ;;
    *)
        log_error "Unknown command: $1"
        echo "Run 'cct help' for usage."
        exit 1
        ;;
esac
